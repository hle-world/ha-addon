"""Pydantic models for the HLE add-on management API."""

from __future__ import annotations

from typing import Literal, Optional

from pydantic import BaseModel


class TunnelConfig(BaseModel):
    id: str
    service_url: str
    label: str
    name: Optional[str] = None          # display name; falls back to label if not set
    auth_mode: Literal["sso", "none"] = "sso"
    verify_ssl: bool = False
    websocket_enabled: bool = True
    api_key: Optional[str] = None       # per-tunnel key override; falls back to global
    subdomain: Optional[str] = None     # populated once tunnel connects to relay


class TunnelStatus(TunnelConfig):
    state: Literal["CONNECTED", "CONNECTING", "STOPPED", "FAILED"] = "STOPPED"
    error: Optional[str] = None         # last error line from log when state is FAILED
    public_url: Optional[str] = None
    pid: Optional[int] = None


class AddTunnelRequest(BaseModel):
    service_url: str
    label: str
    name: Optional[str] = None
    auth_mode: Literal["sso", "none"] = "sso"
    verify_ssl: bool = False
    websocket_enabled: bool = True
    api_key: Optional[str] = None


class UpdateTunnelRequest(BaseModel):
    service_url: Optional[str] = None
    label: Optional[str] = None
    name: Optional[str] = None
    auth_mode: Optional[Literal["sso", "none"]] = None
    verify_ssl: Optional[bool] = None
    websocket_enabled: Optional[bool] = None
    api_key: Optional[str] = None       # set to "" to clear the override


class UpdateConfigRequest(BaseModel):
    api_key: str


class AddAccessRuleRequest(BaseModel):
    email: str
    provider: Literal["any", "google", "github", "hle"] = "any"


class SetPinRequest(BaseModel):
    pin: str  # 4-8 digits


class CreateShareLinkRequest(BaseModel):
    duration: Literal["1h", "24h", "7d"] = "24h"
    label: str = ""
    max_uses: Optional[int] = None
