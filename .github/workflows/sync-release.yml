name: Sync release with hle-client

# Triggered automatically by hle-client's publish workflow via repository_dispatch,
# or manually via workflow_dispatch for testing.
#
# Creates a PR on main that bumps the Dockerfile pin only. The config.yaml version
# is bumped by the build workflow AFTER the Docker image is confirmed pushed —
# this prevents HA Supervisor from offering an update before the image is ready.

on:
  repository_dispatch:
    types: [hle-client-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'hle-client version (e.g. v1.2.3 or 1.2.3)'
        required: true

jobs:
  open-pr:
    name: Open version bump PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Resolve version
        id: ver
        run: |
          VERSION="${{ github.event.client_payload.version || github.event.inputs.version }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "sync/hle-client-v${{ steps.ver.outputs.version }}"

      - name: Bump Dockerfile pin
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          # Only bump the Dockerfile pin — config.yaml version is bumped by the
          # build workflow AFTER the Docker image is confirmed pushed, so HA
          # Supervisor never sees a version that doesn't have a built image yet.
          sed -i "s/hle-client==[0-9][0-9.]*/hle-client==${VERSION}/" hle/Dockerfile

      - name: Commit
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          git add hle/Dockerfile
          git commit -m "Sync to hle-client v${VERSION}"
          git push origin "sync/hle-client-v${VERSION}"

      - name: Open PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          gh pr create \
            --base main \
            --head "sync/hle-client-v${VERSION}" \
            --title "Sync to hle-client v${VERSION}" \
            --body "$(cat <<BODY
          ## hle-client v${VERSION} released

          **Review checklist before merging:**
          - [ ] Read the [hle-client v${VERSION} release notes](https://github.com/hle-world/hle-client/releases/tag/v${VERSION})
          - [ ] Check for new API methods in \`ApiClient\` → add backend endpoints + frontend UI if needed
          - [ ] Check for new CLI flags on \`hle expose\` → update \`tunnel_manager.py\` if needed
          - [ ] Test the add-on with the new client version

          **After merging:** create a **pre-release** to trigger the Docker build:
          \`\`\`
          gh release create v${VERSION} --prerelease --title "v${VERSION}" --notes "..."
          \`\`\`
          The build workflow will bump \`config.yaml\` and promote to full release automatically.

          ---
          *Automated bump: \`hle/Dockerfile\` → \`hle-client==${VERSION}\`*
          BODY
          )"
